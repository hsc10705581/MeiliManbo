# === 第一阶段：编译构建 ===
FROM node:20-alpine AS builder

WORKDIR /app

# 复制依赖配置并安装
COPY package.json ./
RUN npm install

# 复制所有源代码
COPY . .

# 执行打包
RUN npm run build

# === 第二阶段：生产部署 ===
FROM nginx:alpine

# 切换到 root 修改配置
USER root

WORKDIR /usr/share/nginx/html

# 清理默认文件
RUN rm -rf ./*

# 从构建阶段复制打包好的资源
COPY --from=builder /app/dist/index.js ./index.js
COPY --from=builder /app/index.html ./index.html
COPY --from=builder /app/metadata.json ./metadata.json

# 覆盖 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 创建环境变量注入脚本
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'echo "window._env_ = {" > /usr/share/nginx/html/env.js' >> /entrypoint.sh && \
    echo 'echo "  LOGIN_USER: \"${LOGIN_USER:-admin}\"," >> /usr/share/nginx/html/env.js' >> /entrypoint.sh && \
    echo 'echo "  LOGIN_PASS: \"${LOGIN_PASS:-admin}\"" >> /usr/share/nginx/html/env.js' >> /entrypoint.sh && \
    echo 'echo "};" >> /usr/share/nginx/html/env.js' >> /entrypoint.sh && \
    echo 'exec nginx -g "daemon off;"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# 修复权限
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

EXPOSE 80

# 使用自定义入口脚本
ENTRYPOINT ["/entrypoint.sh"]