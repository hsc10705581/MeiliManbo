# === 第一阶段：编译构建 ===
FROM node:20-alpine AS builder

WORKDIR /app

# 复制依赖配置并安装
COPY package.json ./
RUN npm install

# 复制所有源代码
COPY . .

# 执行打包 (esbuild 会将所有 tsx/ts 打包到 dist/index.js)
RUN npm run build

# === 第二阶段：生产部署 ===
FROM nginx:alpine

# 切换到 root 修改配置
USER root

WORKDIR /usr/share/nginx/html

# 清理默认文件
RUN rm -rf ./*

# 从构建阶段复制打包好的 JS 和 静态 HTML
COPY --from=builder /app/dist/index.js ./index.js
COPY --from=builder /app/index.html ./index.html
# 复制其他必要资源（如有）
COPY --from=builder /app/metadata.json ./metadata.json

# 覆盖 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 修复权限
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]